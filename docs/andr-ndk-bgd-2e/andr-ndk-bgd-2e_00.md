# 前言

Android NDK 通过利用这些移动设备的最大速度，将高性能和可移植代码注入你的移动应用中。Android NDK 允许你为密集型任务编写快速代码，并将现有代码移植到 Android 和非 Android 平台。另外，如果你有一个包含多行 C 代码的应用程序，使用 NDK 可以显著减少项目开发过程。这是多媒体和游戏中最有效的操作系统之一。

这本初学者指南将向你展示如何创建由 C/C++支持的应用程序，并将它们与 Java 集成。通过使用这个实用的分步指南，并逐步使用教程、技巧和窍门来练习你的新技能，你将学会如何在 Java 应用程序中嵌入 C/C++代码，或者在一个独立的应用程序中运行。

本书首先会教你如何访问一些最成功的 Android 应用程序中使用的原生 API 和端口库。接下来，你将通过完整实现一个原生 API 和移植现有的第三方库，来创建一个真正的原生应用程序项目。随着章节的深入，你将详细了解使用 OpenGL ES 和 OpenSL ES 渲染图形和播放声音的细节，这些正在成为移动领域的新标准。继续前进，你将学会如何访问键盘和输入外设，以及读取加速度计或方向传感器。最后，你将深入探讨更高级的主题，如 RenderScript。

到本书结束时，你将足够熟悉关键要素，开始利用原生代码的强大功能和可移植性。

# 本书内容

第一章，*设置你的环境*，涵盖了我们系统上安装的所有必备软件包。这一章还介绍了安装 Android Studio 软件包，其中包含了 Android Studio IDE 和 Android SDK。

第二章，*开始一个原生 Android 项目*，讨论了如何使用命令行工具构建我们的第一个示例应用程序，以及如何将其部署在 Android 设备上。我们还将使用 Eclipse 和 Android Studio 创建我们的第一个原生 Android 项目。

第三章，*使用 JNI 接口 Java 和 C/C++*，介绍了如何让 Java 与 C/C++通信。我们还处理在本地代码中使用全局引用的 Java 对象引用，并了解局部引用的差异。最后，我们在本地代码中引发并检查 Java 异常。

第四章，*从本地代码调用 Java*，使用 JNI 反射 API 从本地代码调用 Java 代码。我们还借助 JNI 以本地方式处理位图，并手动解码视频馈送。

第五章，*编写完全本地应用程序*，讨论了创建`NativeActivity`以相应地开始或停止本地代码轮询活动事件。我们还以本地方式访问显示窗口，例如位图以显示原始图形。最后，我们获取时间，使应用程序能够使用单调时钟适应设备速度。

第六章，*使用 OpenGL ES 渲染图形*，涵盖了如何初始化 OpenGL ES 上下文并将其绑定到 Android 窗口。然后，我们了解如何将`libpng`转换为一个模块，并从 PNG 资源中加载纹理。

第七章，*使用 OpenSL ES 播放声音*，涵盖了如何在 Android 上初始化 OpenSL ES。然后，我们学习如何从编码文件播放背景音乐以及使用声音缓冲队列在内存中播放声音。最后，我们了解到如何以线程安全和非阻塞的方式录制和播放声音。

第八章，*处理输入设备和传感器*，讨论了多种从本地代码与 Android 交互的方式。更准确地说，我们了解到如何将输入队列附加到 Native App Glue 事件循环。

第九章，*将现有库移植到 Android*，涵盖了如何在 NDK makefile 系统中通过一个简单的标志激活 STL。我们将 Box2D 库移植为一个可在 Android 项目中重复使用的 NDK 模块。

第十章，*使用 RenderScript 进行密集计算*，介绍了 RenderScript，这是一种用于并行化密集计算任务的高级技术。我们还了解如何使用预定义的 RenderScript 与内置的 Intrinsics，这目前主要用于图像处理。

# 本书所需的条件

要运行本书中的示例，需要以下软件：

+   系统：Windows，Linux 或 Mac OS X

+   JDK：Java SE 开发工具包 7 或 8

+   Cygwin：仅在 Windows 上

# 本书适合的读者

你是一个需要更高性能的 Android Java 程序员吗？你是一个不想为 Java 及其失控的垃圾收集器复杂性而烦恼的 C/C++开发者吗？你想创建快速、密集的多媒体应用程序或游戏吗？如果你对这些问题中的任何一个回答了“是”，那么这本书就是为你准备的。有了对 C/C++开发的一些基本了解，你将能够一头扎进本地 Android 开发。

# 部分

在本书中，你会发现有几个经常出现的标题（动手时间，刚才发生了什么？，小测验，以及尝试英雄）。

为了清楚地说明如何完成一个过程或任务，我们按照以下方式使用这些部分：

# 动手时间——标题

1.  动作 1

1.  动作 2

1.  动作 3

指令通常需要一些额外的解释以确保它们有意义，因此它们后面会跟着这些部分：

## *刚才发生了什么？*

本节解释了你刚刚完成的任务或指令的工作原理。

你在书中还会找到一些其他的学习辅助工具，例如：

## 尝试英雄——标题

这些是实践挑战，它们可以启发你尝试所学的知识。

# 约定

你还会发现一些文本样式，它们可以区分不同类型的信息。以下是一些样式示例及其含义的解释。

文本中的代码字、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 处理程序会以下面的形式显示："最后，创建一个新的 Gradle 任务`ndkBuild`，它将手动触发`ndk-build`命令。"

代码块设置如下：

```java
#include <unistd.h>
…
sleep(3); // in seconds
```

当我们希望引起你注意代码块中的某个特定部分时，相关的行或项目会以粗体显示：

```java
    if (mGraphicsManager.start() != STATUS_OK) return STATUS_KO;

    mAsteroids.initialize();
    mShip.initialize();

    mTimeManager.reset();
    return STATUS_OK;
```

任何命令行输入或输出都会以下面的形式编写：

```java
adb shell stop
adb shell setprop dalvik.vm.checkjni true

```

**新** **术语**和**重要** **词汇**会以粗体显示。你在屏幕上看到的词，比如菜单或对话框中的，会在文本中像这样出现："如果一切正常，当你的应用程序启动时，Logcat 中会出现一个消息**Late-enabling – Xcheck:jni**。"

### 注意

警告或重要注意事项会像这样出现在一个框里。

### 提示

提示和技巧会像这样出现。

# 读者反馈

我们始终欢迎读者的反馈。告诉我们你对这本书的看法——你喜欢或不喜欢什么。读者的反馈对我们很重要，因为它帮助我们开发出你真正能从中获得最大收益的标题。

要向我们发送一般反馈，只需发送电子邮件到`<feedback@packtpub.com>`，并在邮件的主题中提及书籍的标题。

如果你有一个有专业知识的主题，并且你对于写作或为书籍做贡献感兴趣，请查看我们在[www.packtpub.com/authors](http://www.packtpub.com/authors)的作者指南。

# 客户支持

既然你现在拥有了 Packt 的一本书，我们有一些事情可以帮助你最大限度地利用你的购买。

## 下载示例代码

你可以从你在[`www.packtpub.com`](http://www.packtpub.com)的账户下载你所购买的 Packt Publishing 书籍的示例代码文件。如果你在其他地方购买了这本书，可以访问[`www.packtpub.com/support`](http://www.packtpub.com/support)注册，我们会直接将文件通过电子邮件发送给你。

## 勘误

尽管我们已经竭尽全力确保内容的准确性，但错误仍然可能发生。如果您在我们的书中发现了一个错误——可能是文本或代码中的错误——如果您能向我们报告，我们将不胜感激。这样做可以节省其他读者的时间，并帮助我们在后续版本中改进这本书。如果您发现任何勘误信息，请通过访问[`www.packtpub.com/submit-errata`](http://www.packtpub.com/submit-errata)，选择您的书籍，点击**Errata Submission Form**链接，并输入您的勘误详情。一旦您的勘误信息被验证，您的提交将被接受，并且勘误信息将被上传到我们的网站或添加到该标题下的现有勘误列表中。

要查看之前提交的勘误信息，请前往[`www.packtpub.com/books/content/support`](https://www.packtpub.com/books/content/support)，并在搜索字段中输入书名。所需信息将在**Errata**部分下显示。

## 盗版

互联网上对版权材料的盗版是一个所有媒体都面临的持续问题。在 Packt，我们非常重视保护我们的版权和许可。如果您在互联网上以任何形式遇到我们作品的非法副本，请立即提供位置地址或网站名称，以便我们可以寻求补救措施。

如果您有疑似盗版材料的链接，请通过`<copyright@packtpub.com>`联系我们。

我们感谢您帮助保护我们的作者以及我们为您提供有价值内容的能力。

## 问题

如果您对本书的任何方面有问题，可以通过`<questions@packtpub.com>`联系我们，我们将尽力解决问题。
