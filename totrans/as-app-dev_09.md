# 第九章. 发布准备

在前面的章节中，你已经学到了足够多的知识来测试和调试你的应用程序。那么，为了发布你的应用程序，你需要做哪些准备？如何使用 Android Studio 完成这些工作？

本章介绍了使用 Android Studio 准备应用程序发布的必要步骤。首先，我们将了解应用程序包文件，这是 JAR 文件的一种变体，安卓应用程序就是通过它来打包的。然后，我们将了解在完全测试应用程序后，我们需要对其进行哪些更改。最后，我们将签署我们的应用程序 APK（**应用程序包**）文件，使其准备好上传到任何市场，如 Google Play。

这是我们将在本章中讨论的主题：

+   发布准备

+   APK 文件

+   获取证书

+   生成签名的 `APK`

# 什么是 APK 文件

安卓应用程序打包在一个带有 `.APK` 扩展名的文件中，这是 Java JAR（**Java 归档**）文件的一种变体。这些文件实际上只是压缩的 ZIP 文件，因此其内容可以轻松查看。APK 文件通常包含以下内容：

+   `assets/`：一个包含应用程序资产文件的文件夹。这是项目中已存在的 `assets` 文件夹。

+   `META-INF/`：一个包含我们证书的文件夹。

+   `lib/`：如果需要处理器，则包含编译后的代码的文件夹。

+   `res/`：一个包含应用程序资源的文件夹。

+   `AndroidManifest.xml`：应用程序的清单文件。

+   `classes.dex`：一个包含应用程序编译后代码的文件。

+   `resources.arsc`：一个包含一些预编译资源的文件。

有了 `APK` 文件，应用程序可以在 Android 操作系统上进行分发和安装。你可以根据自己的喜好分发安卓应用程序，通过 Google Play、Amazon Appstore 或 Opera Mobile Store 等应用市场；通过自己的网站；或者甚至通过电子邮件发送给你的用户。如果你选择最后两种选项中的任何一种，请记住 Android 默认会阻止来自 Google Play 之外位置的安装。你应该通知你的用户，他们需要在设备上取消此限制才能安装你的应用程序。他们需要从 Android 设备的 **设置** | **安全** 菜单中勾选 **未知来源** 选项。

应用程序在构建时必须使用私钥进行签名。如果应用程序没有签名，它就不能在设备或模拟器上安装。为了构建我们的应用程序，有两种模式：调试和发布。这两个 `APK` 版本包含相同的文件夹和编译后的文件。不同之处在于用于签名的密钥：

+   **调试**：在前面的章节中，我们运行和测试应用时处于调试模式，但我们没有密钥，也没有对应用进行签名。Android SDK 工具会自动创建一个用于签名`APK`的调试密钥、别名及其密码。当我们使用 Android Studio 运行或调试应用时，这个过程会自动发生，而我们甚至没有意识到。我们不能发布使用 SDK 工具创建的调试密钥签名的`APK`。

+   **发布**：当我们想要在其他 Android 设备上分发我们的应用时，我们必须构建一个发布版本。要求`APK`文件使用开发者保留私钥的证书进行签名。在这种情况下，我们需要自己的私钥、别名和密码，并将它们提供给构建工具。证书标识了应用的开发者，可以是自签名的证书。不需要证书颁发机构签名证书。

    ### 提示

    将带有你证书的密钥库保存在安全的地方。为了升级你的应用，你必须使用相同的密钥来上传新版本。如果你丢失了密钥库，你将无法更新你的应用。你将不得不创建一个具有不同包名的全新应用。

# 之前的步骤

在我们生成`APK`文件之前，有必要为发布模式构建我们的应用做好准备。

首先，确保你已经彻底测试了你的应用。我们建议在以下情况下测试你的应用：

+   在使用最低要求平台的设备上进行测试。

+   在使用目标平台的设备上进行测试。

+   在使用最新可用平台的设备上进行测试。

+   在真实设备上，而不仅仅是模拟器中。

+   在各种屏幕分辨率和尺寸上进行测试。

+   如果你的应用支持平板电脑，请在平板上进行测试。

+   如果你允许，切换到横屏模式，无论是在手机还是平板电脑上。

+   在不同的网络条件下，例如没有互联网连接或覆盖范围低。

+   如果你的应用使用了 GPS 或任何定位服务，请在不激活设备上的这些服务时进行测试。

+   返回按钮的行为

第二，我们必须检查从我们的应用打印出的日志消息。打印某些日志消息可能被视为安全漏洞。由 Android 系统生成的日志可以被捕获和分析，因此我们应避免显示关于应用内部工作原理的敏感信息。你还应该从应用清单文件中移除`android:debuggable`属性。你也可以将此属性设置为`false`。

第三，如果你的应用与服务器通信，请检查配置的 URL 是否是生产环境的。在调试阶段，你可能引用了一个预发布环境中的服务器 URL。

最后，从应用程序清单文件中设置`android:versionCode`和`android:versionName`属性的准确值。版本代码是一个数字（整数），表示应用程序版本。新版本应该有更高的版本代码。此代码用于确定设备中安装的应用程序是否为最新版本，或者有更新的版本。

版本名称是一个表示应用程序版本的字符串。与版本代码不同，版本名称对用户可见，并出现在应用程序的公开信息中。它只是向用户提供的版本信息，不用于任何内部目的。

为版本代码指定值 1，版本名称为 1.0。清单标签应如下所示： 

```java
<manifest 
    package="com.example.myapplication"
    android:versionCode="1"
    android:versionName="1.0" >
```

我们应用程序的新版本将为版本代码赋予值 2，版本名称可以是 1.1。

```java
<manifest 
    package="com.example.myapplication"
    android:versionCode="2"
    android:versionName="1.1" >
```

# 生成签名 APK

要生成签名的`APK`，请导航到菜单**构建** | **生成签名 APK**。在生成签名`APK`的对话框中，系统会要求我们提供证书。`APK`由该证书签名，表示它属于我们。

如果这是我们第一个应用程序，可能我们没有任何证书。点击**创建新证书**按钮以打开创建新密钥库的对话框。我们必须填写以下信息。

+   **密钥库路径**：在系统中创建密钥库的路径。密钥库是一个带有`.jks`扩展名的文件。例如，将其命名为`release_keystore.jks`。

+   **密码**：密钥库密码。你必须确认它。

+   **别名**：证书及其公私钥对的别名。例如，将其命名为`releasekey`。

+   **密码**：证书密码。你必须确认它。

+   **有效期**：证书将直到有效期结束。建议使用 25 年或更长时间的值。

+   **证书**：证书中包含的个人资料信息。输入你的名字和姓氏、组织单位、组织、城市或地区、州或省、国家代码。例如，将**组织单位**命名为`AS example`，**组织**命名为`packtpub`，以及**国家代码**命名为`ES`。

点击**确定**。现在已加载用于创建签名`APK`的对话框，其中包含密钥库数据。下次我们创建签名`APK`时，我们已经有了证书，因此我们将点击**选择现有**按钮。点击**下一步**按钮。在下一步中，选择保存`APK`文件的路径并点击**完成**。当 APK 完全生成时，我们将得到通知，如下面的截图所示：

![生成签名 APK](img/5273OS_09_01.jpg)

我们应该在所选路径中创建 APK 文件。点击**在资源管理器中显示**按钮以打开包含生成包的文件夹，或点击**关闭**按钮仅关闭消息。

既然我们已经有了发布 APK 文件，建议在分发之前在设备上再次进行测试。

# 摘要

我们已经学习了如何制作一个`APK`文件以及如何修改我们的应用程序以便发布。我们还学习了如何使用我们的开发者证书为应用签名。在本章结束时，用户应该已经生成了一个准备好发布的已签名`APK`。

在下一章中，我们将学习如何使用 Android Studio 获得帮助。我们将访问 Android Studio 的在线文档，并浏览帮助主题。最后，我们还将学习如何使用内置功能保持我们的 Android Studio 实例更新。
