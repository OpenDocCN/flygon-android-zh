# 第八章. 调试

调试环境是 IDE 最重要的功能之一。使用调试工具可以轻松优化你的应用程序并提高其性能。在 Android Studio 中编程时，你想使用这些调试工具之一吗？Android Studio 包括**Dalvik Debug Monitor Server**（**DDMS**）调试工具。

在本章中，我们将从了解运行和调试选项开始，以及如何在前一章学到的 Android 虚拟设备中模拟我们的应用程序。我们将深入探讨调试器标签页、控制台标签页和 LogCat 标签页。我们还将学习如何使用调试器设置断点，以及如何运行我们的应用程序并在这些断点处停止。我们将在本章最后介绍 Android Studio DDMS 中包含的高级调试工具的每个标签页的信息。

这是我们将在本章中介绍的主题：

+   调试

+   LogCat

+   DDMS 工具

# 运行与调试

Android 应用程序可以通过 Android Studio 在真实设备上使用 USB 连接或在虚拟设备上使用模拟器运行。虚拟设备使我们能够在不同的硬件和软件配置中测试我们的应用程序。由于简单和灵活性，在本章中我们使用模拟器来运行和调试我们的应用程序。

要直接运行一个应用程序，请导航到菜单 **运行** | **运行 'MyApplication'**。你也可以从工具栏中点击播放图标按钮。要调试一个应用程序，请导航到菜单 **运行** | **调试 'MyApplication'**，或者从工具栏中点击虫子图标。

当我们选择调试选项时，会打开一个选择设备的对话框。第一个选项是选择正在运行设备；列出可用的连接设备，无论是真实的还是虚拟的。第二个选项是启动模拟器的新实例；列出可用的虚拟设备。勾选**启动模拟器**选项，并选择在第七章，*工具*中创建的虚拟设备。点击**确定**。模拟器将被启动。下次我们运行或调试应用程序时，模拟器已经在运行，因此我们将选择第一个选项（**选择一个运行中的设备**）。

![运行与调试](img/5273OS_08_01.jpg)

在调试过程中，在 Android Studio 的底部有三个标签页：**调试器**，**控制台**，和**LogCat**。

**控制台**显示在启动模拟器时发生的事件。打开它以检查消息，并确认模拟器和应用程序是否正确执行。应该出现的操作有：

+   `等待设备`：启动模拟器时的起始点。

+   `上传文件`：应用程序被打包并存储在设备上。

+   `安装`：应用程序正在设备上安装。安装完成后应该会打印成功消息。

+   `启动应用程序`：应用程序开始执行。

+   `等待进程`：应用程序现在应该正在运行，调试系统尝试连接到设备中的应用程序进程。

完成以上步骤后，应用程序将在模拟器中可见。通过在文本输入中输入任何名字并点击**接受**按钮来测试它。问候语应该会改变。

**调试器**管理断点，控制代码的执行，并显示有关变量的信息。要在我们的代码中添加断点，只需点击行代码左侧边缘。行代码旁边会出现一个红点来指示断点。要删除断点，请点击它。如果使用鼠标右键点击断点，将提供更多选项。我们可以禁用它而不删除它，或者为断点设置条件。

在我们主活动的`onAcceptClick`方法的条件语句中添加一个断点，并再次调试应用程序。

![运行和调试](img/5273OS_08_02.jpg)

在应用程序中输入你的名字并点击**接受**按钮。当执行到断点时，它会暂停并打开调试标签页。由于我们在条件语句中添加了断点，在分配文本之前，我们的问候语还没有改变。

从调试标签页我们可以检查方法调用层次结构和执行到该点时的变量状态。可用的变量包括方法的参数（`v`）、通过`findViewById`方法获得的`TextView`和`EditText`对象以及当前活动的引用（`this`）。展开名为`et_name`的`EditText`对象，查找`mText`属性。这个属性应该包含你之前输入的名字：

+   要在不进入方法调用的情况下执行下一行代码，请导航到**运行** | **单步跳过**或使用为此选项指定的键盘快捷键，通常是*F8*键。

+   要进入方法调用，请导航到**运行** | **单步执行**或按*F7*键。

+   要执行到下一个断点（如果有的话），请导航到**运行** | **恢复程序**或按*F9*键。

+   要停止执行，请导航到**运行** | **停止**或按*Ctrl* + *F2*键。

这些选项（以及其他选项）也可以从调试标签页作为图标快捷方式使用。

展开对象`tv_greeting`以检查其`mText`属性的值。现在单步跳过条件语句并单步跳过`setText`方法的调用。注意`mText`属性的值是如何改变的。最后，恢复执行，以便在设备屏幕上更改问候语。

# LogCat

**LogCat** 是 Android 的日志系统，它显示运行设备中由 Android 系统生成的所有日志消息。日志消息有几个重要性级别。从 LogCat 标签页我们可以根据这些级别过滤日志消息。例如，如果我们选择信息级别作为过滤器，那么来自信息、警告和错误级别的消息将被显示。

![LogCat](img/5273OS_08_03.jpg)

要从我们的代码中打印日志信息，需要导入`Log`类。这个类为每个级别都有一个方法：`v`方法用于调试级别，`d`方法用于详细，`i`方法用于信息，`w`方法用于警告，`e`方法用于错误信息。这些方法接收两个字符串参数。第一个字符串参数通常标识消息的来源类，第二个字符串参数标识消息本身。为了标识来源类，我们建议使用一个常量静态字符串标签，尽管在下一个示例中我们直接使用字符串以简化代码。在我们的主活动的`onAcceptClick`方法中添加以下日志信息：

```java
if(et_name.getText().length() > 0) {
 Log.i("MainActivity", "Name read: " + et_name.getText());
tv_greeting.setText("Hello " + et_name.getText());
} 
else {
 Log.w("MainActivity", "No name typed, greeting didn't change");
}
```

我们有一条日志信息用于提示从用户输入获取的名称，以及一条如果用户未输入任何名称则打印警告的日志信息。移除之前创建的任何断点，然后调试应用程序。

LogCat 标签打印了设备生成的所有日志信息，因此阅读我们应用程序的消息可能会比较复杂。我们需要过滤这些消息。在 LogCat 标签中有一个可扩展的列表，默认选择**无过滤**选项。展开它并选择**编辑过滤器配置**选项。将打开一个创建过滤器的对话框。可以使用正则表达式通过它们的标签或内容、打印它们的软件包名称、进程 ID（PID）或它们的级别来过滤日志消息。

创建一个名为`MyApplication`的新过滤器，并使用我们应用程序的包作为值，通过**包名称**进行过滤：`com.example.myapplication`。点击**确定**。现在 LogCat 日志已经过过滤，更容易阅读我们的消息。

1.  将焦点放在模拟器窗口上，在应用程序中输入一个名字，并点击**接受**。观察我们的日志信息如何在 LogCat 视图中打印出来。

1.  在应用程序中删除你的名字并点击**接受**。这次，打印了警告信息。注意每种类型消息使用的不同颜色。

如果我们双击 LogCat 入口，可以导航到生成该日志信息的源代码行。

# DDMS

Dalvik 调试监控服务器（DDMS）是 SDK 中一个更高级的调试工具，它也已经集成到 Android Studio 中。这个工具能够监控真实设备和模拟器。

要打开 DDMS 透视图，请导航到**工具** | **Android** | **监控（包含 DDMS）**。你也可以从工具栏点击 Android 图标按钮。将打开一个新的窗口，并显示 DDMS 透视图。

窗口的左侧显示了已连接设备的列表。目前，仅列出我们的虚拟设备。在设备部分，还展示了每个设备上运行的过程列表。我们应该能够在之前启动的设备的进程中找到我们的应用程序。从设备部分的工具栏中，我们可以使用停止标志图标按钮停止一个进程。我们还可以通过点击相机图标按钮来捕获虚拟设备的屏幕截图。其他一些选项将在后面解释。

窗口的右侧提供了设备的详细信息，这些信息分为七个标签页：**线程**，**堆**，**分配跟踪器**，**网络统计**，**文件浏览器**，**模拟器控制**和**系统信息**。窗口的底部是 LogCat，它也已经被集成到了 DDMS 视角中。

## 线程

线程标签页显示属于所选进程的线程列表。从设备部分选择我们的应用程序进程，进程通过包名`com.example.myapplication`进行标识。点击设备部分工具栏中的**更新线程**图标按钮，线程将被加载到标签页的内容中。

![线程](img/5273OS_08_04.jpg)

第一列是线程的 ID。**状态**列指示线程的状态，**utime**表示线程执行用户代码的总时间，**stime**表示线程执行系统代码的总时间，**名称**表示线程的名称。我们感兴趣的线程是那些花费时间执行我们用户代码的线程。

如果我们在应用程序中除了主线程之外创建线程，这个工具将非常有用。我们可以检查它们是否在应用程序的某个点上正在执行，或者它们的执行时间是否适度。

## 方法分析

方法分析是测量选定进程中方法执行性能的工具。测量的参数是调用次数和执行时花费的 CPU 时间。有两种类型的耗时，即独占时间和包含时间：

+   **独占时间**：在执行方法本身时花费的时间。

+   **包含时间**：在执行方法中花费的总时间。这个度量包括在方法内部调用的任何方法所花费的时间。这些被调用的函数被称为它的子方法。

要收集方法分析数据，请从设备部分选择我们的应用程序进程，然后点击设备部分工具栏中的**开始方法分析**图标按钮，该按钮位于**更新线程**图标按钮旁边。接着在应用程序中执行一些操作，例如，在我们的示例应用程序中，输入一个名字并点击**接受**按钮，以执行主活动的`onAcceptClick`方法。通过点击**停止方法分析**图标按钮来停止方法分析。

当方法分析停止时，DDMS 透视图会打开一个带有结果跟踪的新标签。在这个新标签的顶部，方法调用以时间图的形式表示；每一行属于一个线程。在跟踪的底部，以表格形式表示了在方法中花费时间的概要。

按方法名称排序，以搜索我们的`onAcceptClick`方法。点击它以展开有关此方法执行详细的信息。注意以下事实：

+   在`onAcceptClick`方法内部调用的子方法被列出。我们可以看到`EditText.getText`方法、`Activity.findViewById`方法或`TextView.setText`方法，实际上我们直接在下面截图中的方法内调用它们。

+   调用次数。例如，我们可以看到`Activity.findViewById`方法被调用了两次：一次是查找`TextView`对象，第二次是查找`EditText`对象。

+   独占时间列对于父方法或子方法没有值，这是由于这种测量时间类型的自身定义。

![方法分析](img/5273OS_08_05.jpg)

方法分析对于检测执行时间过长的方法非常有用，以便能够优化它们。我们可以了解哪些是最昂贵的方法，以避免对它们进行不必要的调用。

## 堆

堆标签显示了选定进程的堆内存使用信息及统计。选择应用进程，并点击设备部分工具栏中的**更新堆**图标按钮以启用它。堆信息在垃圾收集器（GC）执行后显示。若要强制执行，请点击**触发 GC**按钮，或点击设备部分工具栏中的垃圾图标按钮。

第一个表格显示了堆使用的概要：总大小、已分配空间、空闲空间以及已分配对象的数量。统计表格按类型详细显示了堆中分配的对象：对象数量、这些对象的总大小、最小和最大对象的大小、中位数大小以及平均大小。选择一个类型以加载底部条形图。该图按字节大小绘制了该类型对象的数量。如果我们使用鼠标右键点击图表，可以更改其属性（标题、颜色、字体、标签等）并将其保存为 PNG 格式的图像。

![堆](img/5273OS_08_06.jpg)

## 分配跟踪器

分配跟踪器标签显示了选定进程的内存分配情况。选择应用进程并点击**开始跟踪**按钮以开始跟踪内存信息。然后点击**获取分配**按钮以获取已分配对象列表。

我们可以使用标签页顶部的过滤器来筛选分配在我们自己类中的对象。在过滤器中输入我们的包名，`com.example.myapplication`。对于每个对象，表格显示其分配大小、线程、对象或类，以及分配该对象的方法。点击任何对象查看更多信息，例如，分配它的行号。最后，点击**停止追踪**按钮。

分配追踪器对于检查在应用程序中进行某些交互时分配的对象非常有用，以便改善内存消耗。

## 网络统计

网络统计标签页展示了我们的应用程序如何使用网络资源。要获取使用网络的任何应用程序的网络统计信息，请点击**开始**按钮。数据传输将开始出现在图表中。

网络统计信息有助于优化我们代码中的网络请求，并在执行过程中的某个点控制数据传输。

## 文件浏览器

此标签页暴露了设备上的整个文件系统。对于每个元素，我们可以检查其大小、日期或权限。导航到`/data/app/`以搜索我们的应用程序包文件，`com.example.myapplication.apk`。

## 模拟器控制

模拟器控制允许我们在虚拟设备中模拟一些特殊状态或活动。我们可以在不同的环境和情况下测试我们的应用程序，以确保其行为符合预期。如果我们的应用程序具有依赖于设备物理位置的功能，我们可以使用模拟位置：

+   **通话状态**：选择语音和数据状态，其速度和延迟

+   **通话操作**：模拟来电或短信

+   **位置控制**：设置设备的地理位置

## 系统信息

系统信息标签页以图表形式展示设备的帧渲染时间、总 CPU 负载和总内存使用情况。我们可以搜索我们的应用程序，并将其轻松地与设备上运行的其他进程进行比较。

我们可以更改图表的属性，如颜色、字体、标题，并将其保存为 PNG 格式的图像。要打开这些选项，请使用右键点击图表元素。

当我们的应用程序在前台运行时，打开 CPU 负载并保存图表。然后关闭应用程序，并通过点击**从设备更新**按钮更新 CPU 负载。注意两张图表之间的差异，并注意空闲百分比的升高。

![系统信息](img/5273OS_08_07.jpg)

# 概述

在本章结束时，用户应该了解他们应用程序的不同启动选项以及如何使用控制台和 LogCat 进行调试。他们还应该学会如何调试应用程序，并解读 DDMS 在每个可用标签页中提供的数据。

在下一章中，我们将使用 Android Studio 为我们的应用程序发布做准备。首先，我们会了解在以发布模式构建应用程序之前需要执行的必要步骤。我们将了解应用程序是如何在 `APK` 文件中进行压缩的，以及如何生成我们自己的 `APK`。最后，我们将学习作为开发者如何获取我们的证书，以及如何生成签名的 `APK` 文件，使其准备好发布。
